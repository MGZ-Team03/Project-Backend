# ìœ ì € í”„ë¡œí•„ ì„¤ì • ê¸°ëŠ¥ êµ¬í˜„ ë¡œë“œë§µ

## ğŸ“‹ ê°œìš”

ì‚¬ìš©ìê°€ ìì‹ ì˜ í”„ë¡œí•„ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### í˜„ì¬ User ëª¨ë¸ (DynamoDB)
```
email (PK), name, role, createdAt, userSub
```

### ì¶”ê°€í•  í”„ë¡œí•„ í•„ë“œ
```
profileImage (S3 URL), learningLevel (AI ë¶„ì„ ê¸°ë°˜)
```

### í•™ìŠµ ë ˆë²¨ (learningLevel) ì„¤ëª…
- **ê°’ ê²°ì • ë°©ì‹**: ì „ì›” í•™ìŠµ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Claude AIê°€ ë¶„ì„í•˜ì—¬ ìë™ ì‚°ì¶œ
- **ë ˆë²¨ êµ¬ë¶„**: ìƒ(advanced) / ì¤‘(intermediate) / í•˜(beginner)
- **ì‚¬ìš©ì ìˆ˜ì •**: ë¶ˆê°€ (ì½ê¸° ì „ìš©ìœ¼ë¡œ í‘œì‹œ)

---

## ğŸ¯ êµ¬í˜„ ë²”ìœ„ (MVP)

| ê¸°ëŠ¥ | ìš°ì„ ìˆœìœ„ | ë‚œì´ë„ |
|------|---------|--------|
| í”„ë¡œí•„ ì¡°íšŒ | â˜…â˜…â˜… | ì‰¬ì›€ |
| ì´ë¦„ ë³€ê²½ | â˜…â˜…â˜… | ì‰¬ì›€ |
| í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ | â˜…â˜…â˜… | ì¤‘ê°„ |
| í•™ìŠµ ë ˆë²¨ ì„¤ì • | â˜…â˜…â˜† | ì‰¬ì›€ |

---

## 1ë‹¨ê³„: ë°±ì—”ë“œ - S3 ë²„í‚· ë° ê¶Œí•œ ì„¤ì •

### 1.1 template.yamlì— S3 ë²„í‚· ì¶”ê°€

```yaml
# S3 ë²„í‚· ì •ì˜
ProfileImagesBucket:
  Type: AWS::S3::Bucket
  Properties:
    BucketName: !Sub "speaktracker-profile-images-${AWS::AccountId}"
    CorsConfiguration:
      CorsRules:
        - AllowedHeaders: ["*"]
          AllowedMethods: [GET, PUT]
          AllowedOrigins: ["*"]
          MaxAge: 3000

# AuthFunction í™˜ê²½ ë³€ìˆ˜ì— ì¶”ê°€
AuthFunction:
  Environment:
    Variables:
      PROFILE_IMAGES_BUCKET: !Ref ProfileImagesBucket
  Policies:
    - S3CrudPolicy:
        BucketName: !Ref ProfileImagesBucket
```

---

## 2ë‹¨ê³„: ë°±ì—”ë“œ - User ëª¨ë¸ í™•ì¥

### 2.1 User.java í•„ë“œ ì¶”ê°€

```java
// AuthFunction/src/main/java/com/speaktracker/auth/model/User.java

private String profileImage;      // S3 URL
private String learningLevel;     // beginner, intermediate, advanced

// Getters & Setters ì¶”ê°€
public String getProfileImage() { return profileImage; }
public void setProfileImage(String profileImage) { this.profileImage = profileImage; }

public String getLearningLevel() { return learningLevel; }
public void setLearningLevel(String learningLevel) { this.learningLevel = learningLevel; }
```

### 2.2 UpdateProfileRequest DTO ìƒì„±

```java
// AuthFunction/src/main/java/com/speaktracker/auth/dto/UpdateProfileRequest.java

public class UpdateProfileRequest {
    private String name;
    private String learningLevel;
    
    // Getters & Setters
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public String getLearningLevel() { return learningLevel; }
    public void setLearningLevel(String learningLevel) { this.learningLevel = learningLevel; }
}
```

### 2.3 UserResponse.java í•„ë“œ ì¶”ê°€

```java
// ê¸°ì¡´ í•„ë“œì— ì¶”ê°€
private String profileImage;
private String learningLevel;
```

---

## 3ë‹¨ê³„: ë°±ì—”ë“œ - API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€

### 3.1 AuthHandler.javaì— ë¼ìš°íŠ¸ ì¶”ê°€

```java
// PUT /api/auth/profile
else if ("PUT".equals(httpMethod) && path.endsWith("/profile")) {
    return handleUpdateProfile(input, context);
}
// POST /api/auth/profile/image - Presigned URL ë°œê¸‰
else if ("POST".equals(httpMethod) && path.endsWith("/profile/image")) {
    return handleGetUploadUrl(input, context);
}
```

### 3.2 handleUpdateProfile ë©”ì„œë“œ êµ¬í˜„

```java
private APIGatewayProxyResponseEvent handleUpdateProfile(
    APIGatewayProxyRequestEvent input, Context context) {
    try {
        // 1. JWTì—ì„œ ì´ë©”ì¼ ì¶”ì¶œ
        String email = JwtService.extractEmail(input.getHeaders());
        if (email == null) {
            return createResponse(401, Map.of("error", "ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤"));
        }
        
        // 2. ìš”ì²­ íŒŒì‹±
        UpdateProfileRequest request = objectMapper.readValue(
            input.getBody(), UpdateProfileRequest.class);
        
        // 3. í”„ë¡œí•„ ì—…ë°ì´íŠ¸
        UserResponse response = userService.updateProfile(email, request);
        
        return createResponse(200, response);
    } catch (Exception e) {
        context.getLogger().log("Update profile error: " + e.getMessage());
        return createResponse(500, Map.of("error", "í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"));
    }
}
```

### 3.3 handleGetUploadUrl ë©”ì„œë“œ êµ¬í˜„ (Presigned URL)

```java
private final S3Presigner s3Presigner = S3Presigner.create();
private final String bucketName = System.getenv("PROFILE_IMAGES_BUCKET");

private APIGatewayProxyResponseEvent handleGetUploadUrl(
    APIGatewayProxyRequestEvent input, Context context) {
    try {
        String email = JwtService.extractEmail(input.getHeaders());
        if (email == null) {
            return createResponse(401, Map.of("error", "ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤"));
        }
        
        // íŒŒì¼ í‚¤ ìƒì„± (ì´ë©”ì¼ í•´ì‹œ + íƒ€ì„ìŠ¤íƒ¬í”„)
        String fileKey = "profiles/" + email.hashCode() + "_" + System.currentTimeMillis() + ".jpg";
        
        // Presigned URL ìƒì„± (5ë¶„ ìœ íš¨)
        PutObjectRequest putRequest = PutObjectRequest.builder()
            .bucket(bucketName)
            .key(fileKey)
            .contentType("image/jpeg")
            .build();
        
        PutObjectPresignRequest presignRequest = PutObjectPresignRequest.builder()
            .signatureDuration(Duration.ofMinutes(5))
            .putObjectRequest(putRequest)
            .build();
        
        PresignedPutObjectRequest presignedRequest = s3Presigner.presignPutObject(presignRequest);
        String uploadUrl = presignedRequest.url().toString();
        String imageUrl = "https://" + bucketName + ".s3.amazonaws.com/" + fileKey;
        
        return createResponse(200, Map.of(
            "uploadUrl", uploadUrl,
            "imageUrl", imageUrl
        ));
    } catch (Exception e) {
        context.getLogger().log("Get upload URL error: " + e.getMessage());
        return createResponse(500, Map.of("error", "ì—…ë¡œë“œ URL ìƒì„± ì‹¤íŒ¨"));
    }
}
```

### 3.4 UserService.java ë©”ì„œë“œ ì¶”ê°€

```java
public UserResponse updateProfile(String email, UpdateProfileRequest request) {
    User user = userRepository.findByEmail(email);
    if (user == null) {
        throw new AuthException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
    }
    
    // ë³€ê²½ ê°€ëŠ¥í•œ í•„ë“œë§Œ ì—…ë°ì´íŠ¸
    if (request.getName() != null) {
        user.setName(request.getName());
    }
    if (request.getLearningLevel() != null) {
        user.setLearningLevel(request.getLearningLevel());
    }
    
    userRepository.save(user);
    return UserResponse.from(user);
}

public void updateProfileImage(String email, String imageUrl) {
    User user = userRepository.findByEmail(email);
    if (user == null) {
        throw new AuthException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
    }
    user.setProfileImage(imageUrl);
    userRepository.save(user);
}
```

### 3.5 UserRepository.java - update ë©”ì„œë“œ ì¶”ê°€

```java
public void update(User user) {
    Map<String, AttributeValue> item = new HashMap<>();
    item.put("email", AttributeValue.builder().s(user.getEmail()).build());
    item.put("name", AttributeValue.builder().s(user.getName()).build());
    item.put("role", AttributeValue.builder().s(user.getRole()).build());
    item.put("created_at", AttributeValue.builder().s(user.getCreatedAt()).build());
    
    // ìƒˆ í•„ë“œë“¤ (null ì²´í¬)
    if (user.getProfileImage() != null) {
        item.put("profile_image", AttributeValue.builder()
            .s(user.getProfileImage()).build());
    }
    if (user.getLearningLevel() != null) {
        item.put("learning_level", AttributeValue.builder()
            .s(user.getLearningLevel()).build());
    }
    
    PutItemRequest request = PutItemRequest.builder()
        .tableName(tableName)
        .item(item)
        .build();
    
    dynamoDbClient.putItem(request);
}
```

---

## 4ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ - API ì—°ë™

### 4.1 api/auth.jsì— í•¨ìˆ˜ ì¶”ê°€

```javascript
// í”„ë¡œí•„ ì—…ë°ì´íŠ¸
export const updateProfile = async (profileData) => {
  const response = await axios.put('/api/auth/profile', profileData);
  
  // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
  const currentUser = JSON.parse(localStorage.getItem('user'));
  const updatedUser = { ...currentUser, ...response.data };
  localStorage.setItem('user', JSON.stringify(updatedUser));
  
  return response.data;
};

// í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ URL ìš”ì²­
export const getProfileImageUploadUrl = async () => {
  const response = await axios.post('/api/auth/profile/image');
  return response.data; // { uploadUrl, imageUrl }
};

// S3ì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
export const uploadProfileImage = async (file) => {
  // 1. Presigned URL ìš”ì²­
  const { uploadUrl, imageUrl } = await getProfileImageUploadUrl();
  
  // 2. S3ì— ì§ì ‘ ì—…ë¡œë“œ
  await fetch(uploadUrl, {
    method: 'PUT',
    body: file,
    headers: { 'Content-Type': 'image/jpeg' },
  });
  
  // 3. í”„ë¡œí•„ì— ì´ë¯¸ì§€ URL ì €ì¥
  await updateProfile({ profileImage: imageUrl });
  
  return imageUrl;
};
```

### 4.2 authSlice.jsì— ì•¡ì…˜ ì¶”ê°€

```javascript
export const updateProfile = createAsyncThunk(
  'auth/updateProfile',
  async (profileData, { rejectWithValue }) => {
    try {
      const updatedUser = await apiUpdateProfile(profileData);
      return updatedUser;
    } catch (error) {
      return rejectWithValue(error.message || 'í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
    }
  }
);

// extraReducersì— ì¶”ê°€
.addCase(updateProfile.fulfilled, (state, action) => {
  state.user = { ...state.user, ...action.payload };
})
```

---

## 5ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ - í”„ë¡œí•„ í˜ì´ì§€ UI

### 5.1 ProfilePage.jsx ìƒì„±

```jsx
// src/pages/student/ProfilePage.jsx
import { useState, useEffect, useRef } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import {
  Box, Container, Paper, Typography, TextField, Button,
  Avatar, Select, MenuItem, FormControl, InputLabel,
  Snackbar, Alert, IconButton, CircularProgress
} from '@mui/material';
import { PhotoCamera } from '@mui/icons-material';
import { updateProfile } from '../../store/slices/authSlice';
import { uploadProfileImage } from '../../api/auth';

// í•™ìŠµ ë ˆë²¨ (valueëŠ” AI ë¶„ì„ ê²°ê³¼ë¡œ ìë™ ì„¤ì •ë¨)
const LEVELS = [
  { value: 'beginner', label: 'í•˜ (ì´ˆê¸‰)' },
  { value: 'intermediate', label: 'ì¤‘ (ì¤‘ê¸‰)' },
  { value: 'advanced', label: 'ìƒ (ê³ ê¸‰)' },
];

export default function ProfilePage() {
  const dispatch = useDispatch();
  const user = useSelector((state) => state.auth.user);
  const fileInputRef = useRef(null);
  
  const [form, setForm] = useState({ name: '' });
  const [profileImage, setProfileImage] = useState(null);
  const [uploading, setUploading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (user) {
      setForm({ name: user.name || '' });
      setProfileImage(user.profileImage || null);
    }
  }, [user]);

  const handleImageChange = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) return alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
    if (file.size > 5 * 1024 * 1024) return alert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤');

    setUploading(true);
    try {
      const imageUrl = await uploadProfileImage(file);
      setProfileImage(imageUrl);
      setSuccess(true);
    } catch (error) {
      alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
    setUploading(false);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      await dispatch(updateProfile(form)).unwrap();
      setSuccess(true);
    } catch (error) {
      console.error('Profile update failed:', error);
    }
    setLoading(false);
  };

  return (
    <Container maxWidth="sm" sx={{ py: 4 }}>
      <Paper sx={{ p: 4 }}>
        <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', mb: 3 }}>
          <Box sx={{ position: 'relative' }}>
            <Avatar
              src={profileImage}
              sx={{ width: 100, height: 100, cursor: 'pointer' }}
              onClick={() => fileInputRef.current?.click()}
            >
              {!profileImage && (user?.name?.[0]?.toUpperCase() || '?')}
            </Avatar>
            {uploading ? (
              <CircularProgress size={24} sx={{ position: 'absolute', bottom: 8, right: 0 }} />
            ) : (
              <IconButton
                sx={{ position: 'absolute', bottom: 0, right: 0, bgcolor: 'primary.main', color: 'white' }}
                size="small"
                onClick={() => fileInputRef.current?.click()}
              >
                <PhotoCamera fontSize="small" />
              </IconButton>
            )}
          </Box>
          <input type="file" ref={fileInputRef} hidden accept="image/*" onChange={handleImageChange} />
          <Typography variant="h5" sx={{ mt: 1 }}>í”„ë¡œí•„ ì„¤ì •</Typography>
          <Typography color="text.secondary">{user?.email}</Typography>
        </Box>

        <Box component="form" onSubmit={handleSubmit}>
          <TextField fullWidth label="ì´ë¦„" name="name" value={form.name}
            onChange={(e) => setForm({ ...form, name: e.target.value })} margin="normal" />

          {/* í•™ìŠµ ë ˆë²¨: AI ë¶„ì„ ê²°ê³¼ë¡œ ìë™ ì„¤ì •ë¨ (ì½ê¸° ì „ìš©) */}
          <TextField
            fullWidth
            label="í•™ìŠµ ë ˆë²¨ (AI ë¶„ì„ ê²°ê³¼)"
            value={LEVELS.find(l => l.value === user?.learningLevel)?.label || 'ë¶„ì„ ì¤‘...'}
            margin="normal"
            InputProps={{ readOnly: true }}
            helperText="ì „ì›” í•™ìŠµ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ ì‚°ì¶œë©ë‹ˆë‹¤"
          />

          <Button type="submit" fullWidth variant="contained" sx={{ mt: 3 }} disabled={loading}>
            {loading ? 'ì €ì¥ ì¤‘...' : 'ì €ì¥'}
          </Button>
        </Box>
      </Paper>
      <Snackbar open={success} autoHideDuration={3000} onClose={() => setSuccess(false)}>
        <Alert severity="success">í”„ë¡œí•„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤</Alert>
      </Snackbar>
    </Container>
  );
}
```

### 5.2 App.jsxì— ë¼ìš°íŠ¸ ì¶”ê°€

```jsx
import ProfilePage from './pages/student/ProfilePage';

<Route path="/profile" element={
  <ProtectedRoute allowedRoles={['student', 'tutor']}>
    <ProfilePage />
  </ProtectedRoute>
} />
```

---

## ğŸ“Š êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°±ì—”ë“œ
- [ ] template.yamlì— S3 ë²„í‚· ì¶”ê°€
- [ ] User.javaì— ìƒˆ í•„ë“œ ì¶”ê°€ (profileImage, learningLevel)
- [ ] UpdateProfileRequest.java ìƒì„±
- [ ] AuthHandler.javaì— PUT /api/auth/profile ì¶”ê°€
- [ ] AuthHandler.javaì— POST /api/auth/profile/image ì¶”ê°€ (Presigned URL)
- [ ] UserService / UserRepository êµ¬í˜„
- [ ] sam build && sam deploy

### í”„ë¡ íŠ¸ì—”ë“œ
- [ ] api/auth.jsì— updateProfile(), uploadProfileImage() ì¶”ê°€
- [ ] authSlice.jsì— updateProfile ì•¡ì…˜ ì¶”ê°€
- [ ] ProfilePage.jsx ìƒì„±
- [ ] App.jsxì— ë¼ìš°íŠ¸ ì¶”ê°€

---

## ğŸ• ì˜ˆìƒ ì†Œìš” ì‹œê°„

| ì‘ì—… | ì‹œê°„ |
|------|------|
| S3 ë²„í‚· ë° ê¶Œí•œ ì„¤ì • | 30ë¶„ |
| ë°±ì—”ë“œ ëª¨ë¸/DTO ìˆ˜ì • | 30ë¶„ |
| ë°±ì—”ë“œ API êµ¬í˜„ (Presigned URL í¬í•¨) | 1.5ì‹œê°„ |
| í”„ë¡ íŠ¸ì—”ë“œ API ì—°ë™ | 30ë¶„ |
| í”„ë¡ íŠ¸ì—”ë“œ UI êµ¬í˜„ (ì´ë¯¸ì§€ ì—…ë¡œë“œ í¬í•¨) | 1.5ì‹œê°„ |
| í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹… | 1ì‹œê°„ |
| **ì´ê³„** | **ì•½ 5.5ì‹œê°„** |

---

## ğŸ“ API ëª…ì„¸

### PUT /api/auth/profile

**Request**
```json
{ "name": "í™ê¸¸ë™", "learningLevel": "intermediate" }
```

**Response (200)**
```json
{
  "email": "user@example.com",
  "name": "í™ê¸¸ë™",
  "role": "student",
  "profileImage": "https://bucket.s3.amazonaws.com/profiles/123_456.jpg",
  "learningLevel": "intermediate"
}
```

### POST /api/auth/profile/image

**Response (200)**
```json
{
  "uploadUrl": "https://bucket.s3.amazonaws.com/...?X-Amz-...",
  "imageUrl": "https://bucket.s3.amazonaws.com/profiles/123_456.jpg"
}
```

**ì´ë¯¸ì§€ ì—…ë¡œë“œ íë¦„**
1. `POST /api/auth/profile/image` â†’ uploadUrl, imageUrl ë°›ê¸°
2. `PUT uploadUrl` (S3 ì§ì ‘ ì—…ë¡œë“œ) â†’ bodyì— ì´ë¯¸ì§€ íŒŒì¼
3. `PUT /api/auth/profile` â†’ profileImage: imageUrl ì €ì¥
