---
title: SpeakTracker - AI ëŒ€í™” ì‹œí€€ìŠ¤
---
sequenceDiagram
    autonumber
    participant U as ğŸ‘¤ Student
    participant FE as ğŸ–¥ï¸ React App
    participant Whisper as ğŸ¤ Whisper Worker
    participant API as ğŸ”Œ API Gateway
    participant Lambda as âš¡ Lambda
    participant SQS as ğŸ“¬ SQS
    participant Claude as ğŸ¤– Claude AI
    participant Polly as ğŸ”Š Polly
    participant S3 as ğŸ“¦ S3
    participant DB as ğŸ—„ï¸ DynamoDB
    participant WS as ğŸ”— WebSocket

    rect rgb(230, 245, 255)
        Note over U,WS: 1ï¸âƒ£ AI ëŒ€í™” ì„¸ì…˜ ì‹œì‘
        U->>FE: ëŒ€í™” ì‹œì‘ (ë‚œì´ë„: ì¤‘, ì£¼ì œ: ë ˆìŠ¤í† ë‘)
        FE->>WS: room: "ai-conversation"
        WS->>Lambda: Update student status
        Lambda->>DB: Update TutorStudents (room)
        
        FE->>API: POST /api/ai/conversation/start
        API->>Lambda: Invoke AIHandler
        Lambda->>Claude: ìƒí™© ì„¤ì • í”„ë¡¬í”„íŠ¸<br/>"You are a waiter at a restaurant..."
        Claude-->>Lambda: ì²« AI ë©”ì‹œì§€<br/>"Welcome! Table for how many?"
        Lambda->>SQS: TTS job (AI ë©”ì‹œì§€)
        Lambda->>DB: Put AIConversations
        Lambda-->>FE: {conversationId, aiMessage, audioUrl}
        
        FE->>FE: TTS ì˜¤ë””ì˜¤ ì¬ìƒ
        FE-->>U: ğŸ¤– "Welcome! Table for how many?"
    end

    rect rgb(255, 245, 230)
        Note over U,WS: 2ï¸âƒ£ í•™ìƒ ì‘ë‹µ (Turn 1)
        U->>FE: ğŸ™ï¸ ë…¹ìŒ ì‹œì‘
        FE->>FE: MediaRecorder ì‹œì‘
        U->>U: "Table for two, please"
        U->>FE: ğŸ›‘ ë…¹ìŒ ì¢…ë£Œ
        
        FE->>Whisper: ì˜¤ë””ì˜¤ ì „ì†¡
        Whisper-->>FE: "Table for two please"
        
        FE-->>U: ğŸ’¬ "Table for two please" (ë‚´ ë©”ì‹œì§€)
        
        FE->>API: POST /api/ai/conversation/message
        Note right of FE: conversationId + userMessage
        API->>Lambda: Invoke AIHandler
        Lambda->>Lambda: ë©”íŠ¸ë¦­ ê³„ì‚°
        Note right of Lambda: - ì‘ë‹µ ì§€ì—°ì‹œê°„<br/>- ë°œí™” ë°€ë„<br/>- í˜ì´ìŠ¤ ë¹„ìœ¨
        Lambda->>Claude: ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ + ì‚¬ìš©ì ë©”ì‹œì§€
        Claude-->>Lambda: AI ì‘ë‹µ<br/>"Right this way. Would you like a booth or a regular table?"
        Lambda->>SQS: TTS job
        Lambda->>DB: Update AIConversations (turnCount: 1)
        Lambda-->>FE: {aiMessage, turnCount: 1, metrics}
        
        FE->>FE: TTS ì˜¤ë””ì˜¤ ì¬ìƒ
        FE-->>U: ğŸ¤– "Right this way..."
    end

    rect rgb(230, 255, 230)
        Note over U,WS: 3ï¸âƒ£ ëŒ€í™” ì§„í–‰ (Turn 2~9)
        loop Turn 2 ~ 9
            U->>FE: ğŸ™ï¸ ìŒì„± ì…ë ¥
            FE->>Whisper: STT ë³€í™˜
            Whisper-->>FE: transcribed text
            FE->>API: POST /api/ai/conversation/message
            Lambda->>Claude: ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ìœ ì§€
            Claude-->>Lambda: AI ì‘ë‹µ
            Lambda->>DB: Update turnCount
            Lambda-->>FE: {aiMessage, turnCount: N}
            FE-->>U: ğŸ¤– AI ì‘ë‹µ ì¬ìƒ
        end
    end

    rect rgb(255, 230, 255)
        Note over U,WS: 4ï¸âƒ£ ëŒ€í™” ì¢…ë£Œ (Turn 15 ë˜ëŠ” ìˆ˜ë™)
        alt 15í„´ ë„ë‹¬
            Lambda-->>FE: {isEnded: true, turnCount: 15}
        else í•™ìƒì´ ì¢…ë£Œ
            U->>FE: "END SESSION" ë²„íŠ¼
            FE->>API: POST /api/ai/conversation/end
        end
        
        Lambda->>DB: Update AIConversations (ì™„ë£Œ)
        Lambda->>DB: Update LearningSessions
        Lambda->>DB: Update DailyStatistics
        Note right of DB: - chat_turns_count += 15<br/>- avg_response_quality ì—…ë°ì´íŠ¸<br/>- total_speaking_time ì—…ë°ì´íŠ¸
        
        Lambda-->>FE: ì„¸ì…˜ ìš”ì•½
        Note right of FE: {totalTurns: 15,<br/> avgResponseQuality: 85%,<br/> totalSpeakingTime: 180s}
        
        FE->>WS: room: null (ëŒ€í™” ì¢…ë£Œ)
        WS->>Lambda: Update student status
        Lambda->>DB: Update TutorStudents (room: null)
        
        FE-->>U: ğŸ“Š ëŒ€í™” ê²°ê³¼ ìš”ì•½
        Note right of U: âœ… 15í„´ ì™„ë£Œ<br/>âœ… ì‘ë‹µ í’ˆì§ˆ: 85%<br/>âœ… ì´ ë°œí™” ì‹œê°„: 3ë¶„
    end

    rect rgb(255, 255, 230)
        Note over U,WS: 5ï¸âƒ£ íŠœí„° ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ (ë³‘ë ¬)
        Note over WS: í•™ìƒ ìƒíƒœê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤
        WS-->>FE: STUDENT_STATUS_UPDATE
        Note right of FE: (íŠœí„° ëŒ€ì‹œë³´ë“œì— ì „ë‹¬)
        Note right of FE: í•™ìƒ1: ğŸŸ¢ AI ëŒ€í™” ì¤‘<br/>í•™ìƒ2: ğŸŸ¡ ë¬¸ì¥ ì—°ìŠµ ì¤‘<br/>í•™ìƒ3: âš« ì˜¤í”„ë¼ì¸
    end
