---
title: SpeakTracker - ë¬¸ì¥ ì—°ìŠµ ì‹œí€€ìŠ¤ (TTS + STT + ë°œìŒ í‰ê°€)
---
sequenceDiagram
    autonumber
    participant U as ğŸ‘¤ Student
    participant FE as ğŸ–¥ï¸ React App
    participant Whisper as ğŸ¤ Whisper Worker
    participant API as ğŸ”Œ API Gateway
    participant Lambda as âš¡ Lambda
    participant SQS as ğŸ“¬ SQS
    participant Claude as ğŸ¤– Claude AI
    participant Polly as ğŸ”Š Polly
    participant S3 as ğŸ“¦ S3
    participant DB as ğŸ—„ï¸ DynamoDB

    rect rgb(230, 245, 255)
        Note over U,DB: 1ï¸âƒ£ ì„¸ì…˜ ì‹œì‘ ë° ë¬¸ì¥ ìƒì„±
        U->>FE: ì—°ìŠµ ì‹œì‘ (ë‚œì´ë„: ì¤‘, ì£¼ì œ: ì¼ìƒëŒ€í™”)
        FE->>API: POST /api/sessions/start
        API->>Lambda: Invoke SessionHandler
        Lambda->>DB: Put LearningSessions
        Lambda-->>FE: {sessionId}
        
        FE->>API: POST /api/sentences/generate
        API->>Lambda: Invoke SentenceHandler
        Lambda->>Claude: Generate sentences (ë‚œì´ë„, ì£¼ì œ)
        Claude-->>Lambda: 5ê°œ ë¬¸ì¥ (ì˜ì–´ + í•œê¸€)
        Lambda-->>FE: {sentences, sessionId}
        FE-->>U: ì²« ë²ˆì§¸ ë¬¸ì¥ í‘œì‹œ
    end

    rect rgb(255, 245, 230)
        Note over U,DB: 2ï¸âƒ£ TTS ì˜¤ë””ì˜¤ ìƒì„± (ë¹„ë™ê¸°)
        FE->>API: POST /api/tts
        API->>Lambda: Invoke TTSHandler
        Lambda->>DB: Check cache (ë™ì¼ ë¬¸ì¥)
        
        alt ìºì‹œ íˆíŠ¸
            DB-->>Lambda: audioUrl exists
            Lambda-->>FE: 200 {audioUrl}
        else ìºì‹œ ë¯¸ìŠ¤
            Lambda->>SQS: Send TTS job
            Lambda-->>FE: 202 {jobId, status: PROCESSING}
            
            loop í´ë§ (1ì´ˆ â†’ 3ì´ˆ ë°±ì˜¤í”„)
                FE->>API: GET /api/tts/status/{jobId}
                API->>Lambda: Check status
                Lambda->>DB: Query AsyncJobStatus
                
                alt ì²˜ë¦¬ ì¤‘
                    DB-->>Lambda: PROCESSING
                    Lambda-->>FE: {status: PROCESSING}
                else ì™„ë£Œ
                    SQS->>Lambda: Process TTS job
                    Lambda->>Polly: synthesizeSpeech(text)
                    Polly-->>Lambda: Audio stream
                    Lambda->>S3: Upload audio
                    Lambda->>DB: Update AsyncJobStatus (COMPLETED)
                    Lambda->>DB: Cache audioUrl
                    DB-->>Lambda: COMPLETED
                    Lambda-->>FE: {status: COMPLETED, audioUrl}
                end
            end
        end
        
        FE->>FE: Load audio from CloudFront
        FE-->>U: ğŸ”Š "How are you doing today?"
    end

    rect rgb(230, 255, 230)
        Note over U,DB: 3ï¸âƒ£ í•™ìƒ ë…¹ìŒ ë° STT ë³€í™˜
        U->>FE: ğŸ™ï¸ ë…¹ìŒ ì‹œì‘ ë²„íŠ¼
        FE->>FE: MediaRecorder ì‹œì‘
        U->>FE: ğŸ›‘ ë…¹ìŒ ì¢…ë£Œ ë²„íŠ¼
        FE->>FE: WebM/Opus ì˜¤ë””ì˜¤ ìº¡ì²˜
        
        Note over FE,Whisper: ë¡œì»¬ STT ì²˜ë¦¬ (Whisper)
        FE->>FE: AudioContext ë””ì½”ë”©<br/>(16kHz ë¦¬ìƒ˜í”Œë§, ë…¸ì´ì¦ˆ ì œê±°)
        FE->>Whisper: ì˜¤ë””ì˜¤ ì „ì†¡
        Whisper->>Whisper: STT ë³€í™˜ ì¤‘...
        Whisper-->>FE: "How are you doing today"
    end

    rect rgb(255, 230, 255)
        Note over U,DB: 4ï¸âƒ£ ë°œìŒ í‰ê°€
        FE->>API: POST /api/stt/evaluate
        Note right of FE: audioFile + originalText
        API->>Lambda: Invoke STTHandler
        Lambda->>Lambda: í…ìŠ¤íŠ¸ ë¹„êµ ì•Œê³ ë¦¬ì¦˜
        Note right of Lambda: - Word accuracy<br/>- Completeness score<br/>- Missed/Extra words
        Lambda->>DB: Put PronunciationResults
        Lambda-->>FE: {overallScore: 88.5, grade: "B", feedback: "..."}
        
        FE-->>U: ğŸ“Š ê²°ê³¼ í‘œì‹œ
        Note right of U: âœ… Overall: 88.5ì  (B)<br/>âœ… ì •í™•ë„: 92.3%<br/>âš ï¸ ëˆ„ë½: "are" ë°œìŒ ë¶ˆëª…í™•
    end

    rect rgb(255, 255, 230)
        Note over U,DB: 5ï¸âƒ£ ì„¸ì…˜ ì¢…ë£Œ ë° í†µê³„ ì €ì¥
        U->>FE: ì—°ìŠµ ì¢…ë£Œ ë²„íŠ¼
        FE->>API: POST /api/sessions/end
        API->>Lambda: Invoke SessionHandler
        Lambda->>DB: Update LearningSessions<br/>(duration, speakingDuration)
        Lambda->>DB: Update DailyStatistics<br/>(ì§‘ê³„)
        Lambda-->>FE: {sessionId, duration: 1800}
        FE->>FE: localStorage ìºì‹±
        FE-->>U: "ì˜¤ëŠ˜ 30ë¶„ ì—°ìŠµ ì™„ë£Œ!" ğŸ‰
    end
