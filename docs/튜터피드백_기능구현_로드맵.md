# 튜터 피드백 기능 구현 로드맵

## 📋 프로젝트 개요

**목표**: WebSocket 기반 실시간 튜터 피드백 기능 구현 (Day 10)
**범위**: 학생 상태 고려 없이 핵심 기능만 먼저 구현 (Phase 1)
**주요 기능**: 텍스트/TTS 피드백 전송 및 메시지 저장

---

## Step 1: 데이터 모델 설계

**목표**: DynamoDB 테이블 정의 및 메시지 스키마 설계

### 1.1 FeedbackMessagesTable 속성 추가
- [x] 테이블 생성: **완료** (이미 template.yaml에 정의됨)
  - 테이블 이름: `${StackName}-feedback-messages`
  - Billing Mode: PAY_PER_REQUEST (온디맨드)
  - TTL: 활성화
  - GSI: student_email-timestamp-index

- [x] 기존 스키마
  | 속성 | 타입 | 키 | 설명 |
  |------|------|-----|------|
  | `composite_key` | String | **PK (HASH)** | `${tutor_email}#${student_email}#${session_id}` |
  | `timestamp` | String | **SK (RANGE)** | 메시지 발송 시각 (ISO 8601) |
  | `student_email` | String | GSI | 학생 기준 조회용 |
  | `ttl` | Number | - | TTL (자동 삭제) |

- [ ] **추가할 속성**
  | 속성 | 타입 | 필수 | 설명 |
  |------|------|------|------|
  | `tutor_email` | String | ✅ | 튜터 이메일 |
  | `message_text` | String | ✅ | 피드백 메시지 텍스트 |
  | `message_type` | String | ✅ | 메시지 타입 (text / tts) |
  | `audio_url` | String | ❌ | TTS 오디오 S3 URL (TTS인 경우만) |

### 1.2 WebSocketConnectionsTable 속성 확인
- [x] 테이블 생성: **완료** (이미 template.yaml에 정의됨)
  - 테이블 이름: `${StackName}-websocket-connections`
  - Billing Mode: PAY_PER_REQUEST
  - TTL: 활성화

- [x] 기존 스키마
  | 속성 | 타입 | 키 | 설명 |
  |------|------|-----|------|
  | `connection_id` | String | **PK (HASH)** | API Gateway 자동 생성 ID |
  | `user_email` | String | GSI | 사용자 이메일 |
  | `tutor_email` | String | GSI | 튜터 이메일 (1:N 브로드캐스트용) |
  | `ttl` | Number | - | TTL (자동 삭제) |

---

## Step 2: 백엔드 API 구현 및 WebSocket 통합

**목표**: 튜터 피드백 전송 API 개발 + WebSocket 라우팅 통합

### 2.1 WebSocket 핸들러 분석 (SentencesWebSocketFunction)
- [ ] 기존 WebSocket 라우팅 로직 이해
  - $connect: connection 생성 및 저장
  - $disconnect: connection 삭제
  - $default: 메시지 라우팅

- [ ] 메시지 타입별 처리
  - `connection`: Connection 테이블 저장
  - `status`: 상태 업데이트
  - `feedback`: 피드백 처리
  - `dashboard`: 대시보드 브로드캐스트

- [ ] 기존 코드와의 통합 여부 결정
  - 기존 함수 확장 vs 새로운 함수 생성

### 2.2 SentencesWebSocketFunction 분석
- [ ] 기존 WebSocket 로직 이해
  - 현재 메시지 처리 방식
  - 라우팅 메커니즘
  - 에러 처리 방식

- [ ] 메시지 라우팅 메커니즘 확인
  - WebSocket 연결 관리
  - 메시지 포워딩 방식

- [ ] 필요 시 피드백 전용 엔드포인트 추가 여부 검토
  - 기존 함수 확장 vs 새로운 함수 생성 결정

### 2.3 TutorFeedbackHandler 클래스 작성
- [ ] 클래스 구조 설계
  ```
  TutorFeedbackHandler
  ├── receiveFeedback()          // 피드백 메시지 수신
  ├── saveFeedbackToDB()         // DynamoDB에 저장
  ├── sendToStudentViaWS()       // 학생에게 WebSocket 전송
  ├── broadcastToDashboard()     // 대시보드로 브로드캐스트
  └── handleError()              // 에러 처리
  ```

- [ ] 메서드 구현
  - 피드백 메시지 수신 및 검증
  - DynamoDB에 메시지 저장 (FeedbackMessagesTable)
  - API Gateway Management API로 학생에게 전송
  - 대시보드 상태 업데이트 전송

### 2.4 REST API 엔드포인트 정의
- [ ] 피드백 전송 API
  ```
  POST /api/tutor/feedback
  Content-Type: application/json
  
  요청:
  {
    "student_email": "student@example.com",
    "tutor_email": "tutor@example.com",
    "session_id": "session_123",
    "message": "발음이 좋아졌어요",
    "message_type": "text|tts",
    "audio_url": "s3://bucket/audio.mp3"  // TTS인 경우만
  }
  
  응답:
  {
    "success": true,
    "message_id": "msg_456",
    "timestamp": "2026-01-14T10:30:00Z"
  }
  ```

- [ ] 피드백 조회 API
  ```
  GET /api/tutor/feedback?student_email={email}&limit=50
  
  응답:
  {
    "messages": [
      {
        "composite_key": "tutor@example.com#student@example.com#session_123",
        "timestamp": "2026-01-14T10:30:00Z",
        "message": "발음이 좋아졌어요",
        "message_type": "text",
        "audio_url": "..."
      }
    ],
    "lastEvaluatedKey": "...",
    "count": 10
  }
  ```

- [ ] WebSocket 메시지 형식 (학생에게 전송)
  ```json
  {
    "type": "feedback",
    "from": "tutor@example.com",
    "message": "발음이 좋아졌어요",
    "messageType": "text|tts",
    "audioUrl": "s3://bucket/audio.mp3",
    "timestamp": "2026-01-14T10:30:00Z"
  }
  ```
  
  요청:
  {
    "session_id": "session_123",
    "student_email": "student@example.com",
    "tutor_email": "tutor@example.com",
    "message": "발음이 좋아졌어요",
    "message_type": "text|tts",
    "audio_url": "s3://bucket/audio.mp3"  // TTS인 경우만
  }
  
  응답:
  {
    "success": true,
    "message_id": "msg_456",
    "timestamp": "2026-01-14T10:30:00Z"
  }
  ```

- [ ] WebSocket 메시지 형식 정의
  ```json
  {
    "type": "feedback",
    "from": "tutor@example.com",
    "message": "발음이 좋아졌어요",
    "messageType": "text|tts",
    "audioUrl": "s3://bucket/audio.mp3",
    "timestamp": "2026-01-14T10:30:00Z"
  }
  ```

---

## Step 3: TTS 통합

**목표**: 텍스트 → 음성 변환

### 3.1 AWS Polly 연동
- [ ] Polly 권한 설정
  - IAM 정책: Polly SynthesizeSpeech, S3 PutObject

- [ ] TTS 변환 구현
  ```java
  // AWS Polly로 텍스트 변환
  SynthesizeSpeechRequest request = new SynthesizeSpeechRequest()
      .withText(message)
      .withLanguageCode("ko-KR")
      .withVoiceId(VoiceId.Seoyeon)
      .withOutputFormat(OutputFormat.Mp3);
  ```

- [ ] S3에 오디오 파일 업로드
  - S3 버킷 경로: `s3://bucket/feedback/{session_id}/{timestamp}.mp3`

- [ ] Presigned URL 생성
  - 만료 시간: 24시간
  - 클라이언트에 반환

### 3.2 음성 형식 선택
- [ ] 언어: 한국어 (VoiceId.Seoyeon)
- [ ] 형식: MP3 (브라우저 지원 최적)
- [ ] 샘플 레이트: 기본값 (22050Hz)

---

## Step 4: 메시지 저장 및 조회

**목표**: 피드백 기록 관리

### 4.1 메시지 저장 기능
- [ ] DynamoDB에 메시지 저장
  - PK: session_id, SK: timestamp
  - 트랜잭션 처리 (에러 시 롤백)

- [ ] Timestamp로 순서 보장
  - ISO 8601 형식 사용
  - 밀리초 단위까지 포함

- [ ] Batch write 지원 (선택)
  - 대량 메시지 저장 시 성능 최적화

### 4.2 메시지 조회 API
- [ ] 조회 엔드포인트
  ```
  GET /tutorFeedback/{session_id}?limit=50&startKey={key}
  
  응답:
  {
    "messages": [
      {
        "message_id": "msg_456",
        "from": "tutor@example.com",
        "message": "발음이 좋아졌어요",
        "messageType": "text",
        "timestamp": "2026-01-14T10:30:00Z"
      }
    ],
    "lastEvaluatedKey": "...",
    "count": 50
  }
  ```

- [ ] 페이지네이션 구현
  - limit: 한번에 반환할 메시지 수 (기본값: 50)
  - startKey: 다음 페이지 시작 키

- [ ] 정렬 순서
  - 최근 메시지 먼저 (내림차순)

---

## Step 5: WebSocket 전송 로직

**목표**: 실시간 메시지 전달

### 5.1 WebSocket 라우팅
- [ ] 튜터 메시지 수신
  - POST 요청으로 피드백 수신
  - 메시지 검증

- [ ] 학생에게 Forward
  - API Gateway Management API 사용
  - 학생 WebSocket connection_id로 메시지 전송

- [ ] 메시지 포워드 실패 처리
  - 학생 오프라인 시 에러 처리
  - 재시도 메커니즘 (선택)

### 5.2 메시지 형식 표준화
- [ ] 통일된 메시지 구조
  ```json
  {
    "type": "feedback",
    "from": "tutor@example.com",
    "message": "발음이 좋아졌어요",
    "messageType": "text|tts",
    "audioUrl": "s3://bucket/audio.mp3",
    "timestamp": "2026-01-14T10:30:00Z"
  }
  ```

- [ ] 메시지 타입별 처리
  - `text`: 텍스트 메시지만 표시
  - `tts`: 음성 파일 제공 + 텍스트 표시

---

## Step 6: 목업 테스트

**목표**: 기능 동작 검증

### 6.1 테스트 데이터 생성
- [ ] 샘플 튜터-학생 쌍 생성
  - Tutor: tutor@example.com
  - Student: student@example.com

- [ ] 다양한 피드백 메시지
  - 텍스트: "발음이 좋아졌어요"
  - TTS: "다시 한번 천천히 읽어주세요"

### 6.2 로컬/스테이징 테스트
- [ ] WebSocket 연결 테스트
  ```bash
  # WebSocket 클라이언트로 연결
  wscat -c ws://localhost:8000/websocket
  ```

- [ ] 메시지 송수신 테스트
  - POST /tutorFeedback/send로 피드백 전송
  - 학생 측 WebSocket에서 메시지 수신 확인

- [ ] TTS 음성 생성 테스트
  - Polly 변환 정상 작동 확인
  - S3 업로드 확인
  - Presigned URL 접근 가능 확인

- [ ] 메시지 저장 테스트
  - DynamoDB에 메시지 저장 확인
  - 조회 API로 메시지 목록 확인

---

## Step 7: 프론트엔드 통합

**목표**: 클라이언트에서 피드백 표시

### 7.1 피드백 수신 리스너
- [ ] WebSocket 메시지 리스너 추가
  ```javascript
  websocket.onmessage = (event) => {
    const message = JSON.parse(event.data);
    if (message.type === 'feedback') {
      displayFeedback(message);
    }
  };
  ```

- [ ] 메시지 파싱 및 검증

- [ ] UI 상태 업데이트
  - Redux/상태관리 라이브러리로 피드백 저장
  - 컴포넌트 리렌더링

### 7.2 피드백 표시 UI
- [ ] 피드백 메시지 목록
  - 튜터 아바타 + 이름
  - 메시지 텍스트
  - Timestamp

- [ ] 음성 재생 버튼 (TTS인 경우)
  ```html
  <audio controls>
    <source src={audioUrl} type="audio/mpeg" />
  </audio>
  ```

- [ ] 스타일링
  - 튜터 메시지와 학생 메시지 구분
  - 반응형 디자인

### 7.3 피드백 히스토리
- [ ] 과거 피드백 조회
  - GET /tutorFeedback/{session_id}로 메시지 로드
  - 스크롤 시 추가 로드 (무한 스크롤 또는 페이지네이션)

---

## Step 8: 에러 처리 및 최적화

**목표**: 안정성 향상

### 8.1 에러 처리
- [ ] 메시지 전송 실패 시 재시도
  - 재시도 횟수: 최대 3회
  - 재시도 간격: 1초, 2초, 4초 (exponential backoff)

- [ ] WebSocket 연결 끊김 복구
  - 자동 재연결 로직
  - 재연결 시 미수신 메시지 다시 로드

- [ ] 타임아웃 처리
  - 메시지 전송 타임아웃: 10초
  - 응답 없음 시 에러 메시지 사용자에게 표시

- [ ] 입력값 검증
  - 메시지 길이 제한 (최대 500자)
  - 이메일 형식 검증

### 8.2 로깅
- [ ] 메시지 송수신 로그
  ```
  [2026-01-14 10:30:00] INFO: Feedback sent from tutor@example.com to student@example.com
  [2026-01-14 10:30:05] INFO: Message received by student
  ```

- [ ] 에러 로그
  ```
  [2026-01-14 10:31:00] ERROR: Failed to synthesize speech - {error message}
  [2026-01-14 10:31:05] ERROR: DynamoDB put failed - {error message}
  ```

- [ ] 로그 레벨
  - INFO: 정상 작동
  - WARN: 재시도, 경고
  - ERROR: 에러, 실패

### 8.3 성능 최적화
- [ ] 대량 메시지 처리
  - DynamoDB batch write로 성능 향상
  - Connection pool 관리

- [ ] 메모리 관리
  - 메시지 캐싱 (최근 50개만 메모리 유지)
  - 불필요한 객체 해제

- [ ] 네트워크 최적화
  - 메시지 압축 (선택)
  - CDN을 통한 오디오 파일 배포

---

## 🎯 구현 순서 (권장)

| 단계 | 작업 | 예상 기간 | 담당자 |
|------|------|----------|--------|
| 1 | Step 1-2: DB 설계 및 핵심 API 개발 | 2-3일 | 백엔드 |
| 2 | Step 3: TTS 통합 | 1일 | 백엔드 |
| 3 | Step 4-5: 메시지 저장/조회 및 WebSocket 전송 | 2일 | 백엔드 |
| 4 | Step 6-7: 테스트 및 프론트엔드 통합 | 2-3일 | 풀스택 |
| 5 | Step 8: 최적화 및 오류 처리 | 1-2일 | 백엔드 |

**Total**: 약 8-11일 (병렬 작업 가능 부분 포함)

---

## 📌 체크리스트

### 개발 전
- [ ] DynamoDB 테이블 생성 완료
- [ ] AWS IAM 권한 확인 (Polly, S3, DynamoDB)
- [ ] 프로젝트 환경 설정 (Java, Gradle)

### 개발 중
- [ ] 각 Step별 코드 리뷰
- [ ] 단위 테스트 작성
- [ ] 통합 테스트 실행

### 배포 전
- [ ] 모든 에러 핸들링 검증
- [ ] 성능 테스트 (부하 테스트)
- [ ] 보안 검토 (입력값 검증, 인증)

---

## 🔗 참고 자료

- [AWS API Gateway Management API](https://docs.aws.amazon.com/apigatewaymanagementapi/)
- [AWS Polly Documentation](https://docs.aws.amazon.com/polly/)
- [DynamoDB Best Practices](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/best-practices.html)

