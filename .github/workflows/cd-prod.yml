name: CD (prod)

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Setup AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: SAM build
        run: sam build --parallel

      - name: SAM deploy (prod)
        run: >
          sam deploy
          --config-env prod
          --no-confirm-changeset
          --no-fail-on-empty-changeset
          --region "${{ secrets.AWS_REGION }}"
          --stack-name "${{ secrets.SAM_STACK_NAME }}"
          --parameter-overrides
          "StageName=${{ secrets.STAGE_NAME }} SesSenderEmail=${{ secrets.SES_SENDER_EMAIL }} FrontendUrl=${{ secrets.FRONTEND_URL }}"

