AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Project02-SpeakTracker

  Sample SAM Template for Project02-SpeakTracker

  '
Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: java21
    Architectures:
      - x86_64
    Environment:
      Variables:
        USERS_TABLE: !Ref UsersTable
        TUTOR_STUDENTS_TABLE: !Ref TutorStudentsTable
        TUTOR_REQUESTS_TABLE: !Ref TutorRequestsTable
        NOTIFICATIONS_TABLE: !Ref NotificationsTable
        SESSIONS_TABLE: !Ref LearningSessionsTable
        STATISTICS_TABLE: !Ref DailyStatisticsTable
        AI_CONVERSATIONS_TABLE: !Ref AIConversationsTable
        FEEDBACK_TABLE: !Ref FeedbackMessagesTable
        CONNECTIONS_TABLE: !Ref WebSocketConnectionsTable
        SENTENCES_TABLE: !Ref SentencesTable

Resources:
  # Cognito User Pool for authentication
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "${AWS::StackName}-userpool"
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Schema:
        - Name: email
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: name
          AttributeDataType: String
          Required: true
          Mutable: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: false
          RequireLowercase: false
          RequireNumbers: false
          RequireSymbols: false

  # Cognito User Pool Client
  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub "${AWS::StackName}-client"
      UserPoolId: !Ref UserPool
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_PASSWORD_AUTH
      GenerateSecret: false

  # IAM Roles and DynamoDB Tables
  CommonLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBFullAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt UsersTable.Arn
                  - !GetAtt TutorStudentsTable.Arn
                  - !GetAtt TutorRequestsTable.Arn
                  - !GetAtt NotificationsTable.Arn
                  - !GetAtt LearningSessionsTable.Arn
                  - !GetAtt DailyStatisticsTable.Arn
                  - !GetAtt AIConversationsTable.Arn
                  - !GetAtt FeedbackMessagesTable.Arn
                  - !GetAtt WebSocketConnectionsTable.Arn
                  - !GetAtt SentencesTable.Arn
                  - !GetAtt SentenceAudioTable.Arn
                  - !GetAtt AsyncJobStatusTable.Arn
                  - !GetAtt PronunciationResultsTable.Arn
                  # GSI도 포함
                  - !Sub '${UsersTable.Arn}/index/*'
                  - !Sub '${TutorStudentsTable.Arn}/index/*'
                  - !Sub '${TutorRequestsTable.Arn}/index/*'
                  - !Sub '${NotificationsTable.Arn}/index/*'
                  - !Sub '${LearningSessionsTable.Arn}/index/*'
                  - !Sub '${DailyStatisticsTable.Arn}/index/*'
                  - !Sub '${AIConversationsTable.Arn}/index/*'
                  - !Sub '${FeedbackMessagesTable.Arn}/index/*'
                  - !Sub '${WebSocketConnectionsTable.Arn}/index/*'
                  - !Sub '${SentencesTable.Arn}/index/*'
                  - !Sub '${SentenceAudioTable.Arn}/index/*'
        - PolicyName: SQSSendMessage
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'sqs:SendMessage'
                  - 'sqs:GetQueueUrl'
                Resource:
                  - !GetAtt FeedbackQueue.Arn
                  - !GetAtt NotificationQueue.Arn

        - PolicyName: WebSocketManageConnections
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'execute-api:ManageConnections'
                Resource:
                  - !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*'

        - PolicyName: SecretsManagerReadClaudeKey
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:team3/claude_api_key*'
        - PolicyName: SQSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:SendMessageBatch
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                  - sqs:GetQueueUrl
                Resource:
                  - !GetAtt AIConversationQueue.Arn
                  - !GetAtt TTSQueue.Arn
        - PolicyName: S3TTSReadAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource:
                  - !Sub 'arn:aws:s3:::${TTSBucket}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !GetAtt TTSBucket.Arn
        - PolicyName: S3ProfileImagesAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                Resource:
                  - !Sub '${ProfileImagesBucket.Arn}/*'
        - PolicyName: JobStatusTableAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt AsyncJobStatusTable.Arn
        - PolicyName: SESEmailSend
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ses:SendEmail
                  - ses:SendRawEmail
                Resource: '*'

  # WebSocket Lambda Role
  WebSocketLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBFullAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:*
                Resource:
                  - !GetAtt UsersTable.Arn
                  - !GetAtt TutorStudentsTable.Arn
                  - !GetAtt LearningSessionsTable.Arn
                  - !GetAtt DailyStatisticsTable.Arn
                  - !GetAtt AIConversationsTable.Arn
                  - !GetAtt FeedbackMessagesTable.Arn
                  - !GetAtt WebSocketConnectionsTable.Arn
                  - !GetAtt SentencesTable.Arn
                  - !Sub '${UsersTable.Arn}/index/*'
                  - !Sub '${TutorStudentsTable.Arn}/index/*'
                  - !Sub '${LearningSessionsTable.Arn}/index/*'
                  - !Sub '${DailyStatisticsTable.Arn}/index/*'
                  - !Sub '${AIConversationsTable.Arn}/index/*'
                  - !Sub '${FeedbackMessagesTable.Arn}/index/*'
                  - !Sub '${WebSocketConnectionsTable.Arn}/index/*'
                  - !Sub '${SentencesTable.Arn}/index/*'
        - PolicyName: WebSocketManageConnections
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'execute-api:ManageConnections'
                Resource:
                  - !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*'

  # 1. Users 테이블
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-users'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: role
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: role
          KeyType: HASH
        - AttributeName: email
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: email-index
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Name
          Value: Users Table

  # 2. Tutor-Students 매칭 테이블
  TutorStudentsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-tutor-students'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: tutor_email
          AttributeType: S
        - AttributeName: student_email
          AttributeType: S
      KeySchema:
        - AttributeName: tutor_email
          KeyType: HASH
        - AttributeName: student_email
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: student_email-index
          KeySchema:
            - AttributeName: student_email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Name
          Value: Tutor Students Table

  # 3. Learning Sessions 테이블
  LearningSessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-learning-sessions'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: student_email
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
        - AttributeName: tutor_email
          AttributeType: S
      KeySchema:
        - AttributeName: student_email
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: tutor_email-timestamp-index
          KeySchema:
            - AttributeName: tutor_email
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: Learning Sessions Table

  # 4. Daily Statistics 테이블
  DailyStatisticsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-daily-statistics'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: student_email
          AttributeType: S
        - AttributeName: date
          AttributeType: S
      KeySchema:
        - AttributeName: student_email
          KeyType: HASH
        - AttributeName: date
          KeyType: RANGE
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: Daily Statistics Table

  # 5. AI Conversations 테이블
  AIConversationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-ai-conversations'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: student_email
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
        - AttributeName: conversation_id
          AttributeType: S
      KeySchema:
        - AttributeName: student_email
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: conversation_id-index
          KeySchema:
            - AttributeName: conversation_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: AI Conversations Table

  # 6. Feedback Messages 테이블
  FeedbackMessagesTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub '${AWS::StackName}-feedback-messages'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: composite_key
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
        - AttributeName: student_email
          AttributeType: S
      KeySchema:
        - AttributeName: composite_key
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: student_email-timestamp-index
          KeySchema:
            - AttributeName: student_email
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: Feedback Messages Table

  # 7. WebSocket Connections 테이블
  WebSocketConnectionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-websocket-connections'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: connection_id
          AttributeType: S
        - AttributeName: user_email
          AttributeType: S
        - AttributeName: tutor_email
          AttributeType: S
      KeySchema:
        - AttributeName: connection_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: user_email-index
          KeySchema:
            - AttributeName: user_email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: tutor_email-index
          KeySchema:
            - AttributeName: tutor_email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: WebSocket Connections Table

  # 8. Sentences 테이블
  SentencesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-sentences'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: category
          AttributeType: S
        - AttributeName: sentence_id
          AttributeType: S
      KeySchema:
        - AttributeName: category
          KeyType: HASH
        - AttributeName: sentence_id
          KeyType: RANGE
      Tags:
        - Key: Name
          Value: Sentences Table
  # 9. Async Job Status 테이블 (SQS 비동기 작업 상태 추적)
  AsyncJobStatusTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-async-job-status'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: job_id
          AttributeType: S
      KeySchema:
        - AttributeName: job_id
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: Async Job Status Table

  # 9-1. Sentence Audio Table (문장 연습 세션별 오디오 상태/메타데이터)
  SentenceAudioTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-sentence-audio'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: sessionId
          AttributeType: S
        - AttributeName: sentenceIndex
          AttributeType: N
      KeySchema:
        - AttributeName: sessionId
          KeyType: HASH
        - AttributeName: sentenceIndex
          KeyType: RANGE
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: Sentence Audio Table

  # 10. Pronunciation Results 테이블
  PronunciationResultsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub '${AWS::StackName}-pronunciation-results'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: student_email
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
      KeySchema:
        - AttributeName: student_email
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: Pronunciation Results Table

  # Transcribe Temporary Audio S3 Bucket
  TranscribeTempBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Sub '${AWS::StackName}-transcribe-temp'
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldAudioFiles
            Status: Enabled
            ExpirationInDays: 1
      Tags:
        - Key: Name
          Value: Transcribe Temporary Audio Bucket

  # SQS Queues for async processing
  # TTS Queue
  TTSQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-tts-queue'
      VisibilityTimeout: 120
      MessageRetentionPeriod: 3600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt TTSDeadLetterQueue.Arn
        maxReceiveCount: 3

  TTSDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-tts-dlq'
      MessageRetentionPeriod: 1209600

  # AI Conversation Queue (FIFO)
  AIConversationQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-ai-conversation-queue.fifo'
      FifoQueue: true
      ContentBasedDeduplication: true
      VisibilityTimeout: 120
      MessageRetentionPeriod: 3600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt AIConversationDeadLetterQueue.Arn
        maxReceiveCount: 3

  AIConversationDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-ai-conversation-dlq.fifo'
      FifoQueue: true
      MessageRetentionPeriod: 1209600

  # Profile Images S3 Bucket
  ProfileImagesBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - '*'
            AllowedMethods:
              - GET
              - PUT
            AllowedOrigins:
              - '*'
            MaxAge: 3000
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      Tags:
        - Key: Name
          Value: Profile Images Bucket

  # Profile Images Bucket Policy (Public Read)
  ProfileImagesBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ProfileImagesBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action: 's3:GetObject'
            Resource: !Sub '${ProfileImagesBucket.Arn}/*'

  # TTS Audio S3 Bucket
  TTSBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - '*'
            AllowedMethods:
              - GET
              - HEAD
            AllowedOrigins:
              - '*'
            MaxAge: 3600
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldAudioFiles
            Status: Enabled
            ExpirationInDays: 30
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: TTS Audio Bucket

  # TTS Lambda Role
  TTSLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: PollyAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - polly:SynthesizeSpeech
                Resource: '*'
        - PolicyName: S3TTSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:HeadObject
                Resource:
                  - !Sub 'arn:aws:s3:::${TTSBucket}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !GetAtt TTSBucket.Arn
        - PolicyName: SQSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                  - sqs:GetQueueUrl
                Resource:
                  - !GetAtt TTSQueue.Arn
        - PolicyName: JobStatusTableAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt AsyncJobStatusTable.Arn
        - PolicyName: SentenceAudioTableAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt SentenceAudioTable.Arn
                  - !Sub '${SentenceAudioTable.Arn}/index/*'

  # STT (Speech-to-Text) IAM Roles
  STTLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: STSAssumeTranscribeRole
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sts:AssumeRole
                Resource:
                  - !GetAtt TranscribeClientRole.Arn
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt PronunciationResultsTable.Arn
        - PolicyName: S3TranscribeAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                Resource:
                  - !Sub 'arn:aws:s3:::${TranscribeTempBucket}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !GetAtt TranscribeTempBucket.Arn
        - PolicyName: TranscribeAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - transcribe:StartTranscriptionJob
                  - transcribe:GetTranscriptionJob
                  - transcribe:DeleteTranscriptionJob
                Resource: '*'

  TranscribeClientRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-transcribe-client-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: sts:AssumeRole
      Policies:
        - PolicyName: TranscribeStreamingAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - transcribe:StartStreamTranscription
                Resource: '*'

  HelloWorldFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: HelloWorldFunction
      Handler: helloworld.App::handleRequest
      Role: !GetAtt CommonLambdaRole.Arn
      Events:
        HelloWorld:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /hello
            Method: get
    Metadata:
      SamResourceId: HelloWorldFunction

  TutorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: TutorFunction
      Handler: com.speaktracker.tutor.TutorFeedbackHandler::handleRequest
      Role: !GetAtt CommonLambdaRole.Arn
      Environment:
        Variables:
          FEEDBACK_QUEUE_URL: !Ref FeedbackQueue
          WEBSOCKET_API_ENDPOINT: !Sub 'https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/Dev'
          CONNECTIONS_TABLE: !Ref WebSocketConnectionsTable
          TUTOR_STUDENTS_TABLE: !Ref TutorStudentsTable
          USERS_TABLE: !Ref UsersTable
      Events:
        API1:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/tutor/students
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        API2:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/tutor/students/{email}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        API3:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/tutor/students/{email}/history
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        API4:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/tutor/feedback
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        API5:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/tutor/feedback
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
    Metadata:
      SamResourceId: TutorFunction

  SessionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SessionFunction
      Handler: session.App::handleRequest
      Role: !GetAtt CommonLambdaRole.Arn
      Events:
        API1:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/sessions/start
            Method: post
        API2:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/sessions/end
            Method: post
        API3:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/sessions/history
            Method: get
    Metadata:
      SamResourceId: SessionFunction

  StudentFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: Student API - Get tutor information
      CodeUri: StudentFunction
      Handler: com.speaktracker.student.StudentHandler::handleRequest
      Role: !GetAtt CommonLambdaRole.Arn
      Events:
        API1:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/student/tutor
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
    Metadata:
      SamResourceId: StudentFunction

  SentencesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SentencesFunction
      Handler: sentences.App::handleRequest
      Role: !GetAtt CommonLambdaRole.Arn
      Environment:
        Variables:
          CLAUDE_API_KEY_SECRET_ID: team3/claude_api_key
          AI_CONVERSATION_QUEUE_URL: !Ref AIConversationQueue
          JOB_STATUS_TABLE: !Ref AsyncJobStatusTable
          TTS_QUEUE_URL: !Ref TTSQueue
          TTS_BUCKET: !Ref TTSBucket
          SENTENCE_AUDIO_TABLE: !Ref SentenceAudioTable
          PRESIGNED_URL_EXPIRATION: '3600'
      Events:
        API1:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/sentences
            Method: get
        API2:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/sentences/{id}/audio
            Method: get
        GenerateSentences:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/sentences/generate
            Method: post
        RecommendSentences:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/sentences/recommend
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        SentenceAudioSession:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/sentences/audio/{sessionId}
            Method: get
        SentenceFeedback:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/sentences/feedback
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        ChatStart:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/ai/chat/start
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        ChatMessage:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/ai/chat/message
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
        ChatStatus:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/ai/chat/status/{requestId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        ConversationList:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/ai/conversations
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        ConversationDetail:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/ai/conversations/{conversationId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
    Metadata:
      SamResourceId: SentencesFunction

  # Claude Worker Function (SQS 이벤트 처리)
  ClaudeWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SentencesFunction
      Handler: sentences.ClaudeWorker::handleRequest
      Role: !GetAtt CommonLambdaRole.Arn
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          AI_CONVERSATIONS_TABLE: !Ref AIConversationsTable
          JOB_STATUS_TABLE: !Ref AsyncJobStatusTable
          CLAUDE_API_KEY_SECRET_ID: team3/claude_api_key
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt AIConversationQueue.Arn
            BatchSize: 1
    Metadata:
      SamResourceId: ClaudeWorkerFunction

  TTSFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: TTSFunction
      Handler: com.speaktracker.tts.TTSHandler::handleRequest
      Role: !GetAtt TTSLambdaRole.Arn
      Timeout: 60
      MemorySize: 512
      Environment:
        Variables:
          TTS_BUCKET: !Ref TTSBucket
          PRESIGNED_URL_EXPIRATION: '3600'
          TTS_QUEUE_URL: !Ref TTSQueue
          JOB_STATUS_TABLE: !Ref AsyncJobStatusTable
      Events:
        TTSConvert:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/tts
            Method: post
        TTSStatus:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/tts/status/{jobId}
            Method: get
        KoreanTTSConvert:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/tts/korean
            Method: post
        KoreanTTSStatus:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/tts/korean/status/{jobId}
            Method: get
    Metadata:
      SamResourceId: TTSFunction

  # TTS Worker Function (SQS 이벤트 처리)
  TTSWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: TTSFunction
      Handler: com.speaktracker.tts.TTSWorker::handleRequest
      Role: !GetAtt TTSLambdaRole.Arn
      Timeout: 120
      MemorySize: 512
      Environment:
        Variables:
          TTS_BUCKET: !Ref TTSBucket
          JOB_STATUS_TABLE: !Ref AsyncJobStatusTable
          PRESIGNED_URL_EXPIRATION: '3600'
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt TTSQueue.Arn
            BatchSize: 1
    Metadata:
      SamResourceId: TTSWorkerFunction

  # STT Function
  STTFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: STTFunction
      Handler: com.speaktracker.stt.STTHandler::handleRequest
      Role: !GetAtt STTLambdaRole.Arn
      Timeout: 90
      MemorySize: 512
      Environment:
        Variables:
          TRANSCRIBE_CLIENT_ROLE_ARN: !GetAtt TranscribeClientRole.Arn
          PRONUNCIATION_RESULTS_TABLE: !Ref PronunciationResultsTable
          TRANSCRIBE_BUCKET_NAME: !Ref TranscribeTempBucket
          CREDENTIAL_EXPIRATION_SECONDS: '900'
      Events:
        Evaluate:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/stt/evaluate
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer
    Metadata:
      SamResourceId: STTFunction

  DashboardFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DashboardFunction
      Handler: dashboard.DashboardHandler::handleRequest
      Role: !GetAtt CommonLambdaRole.Arn
      Environment:
        Variables:
          TUTOR_STUDENTS_TABLE: !Ref TutorStudentsTable
          USERS_TABLE: !Ref UsersTable
          SESSIONS_TABLE: !Ref LearningSessionsTable
      Events:
        GetDashboard:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /api/dashboard
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
    Metadata:
      SamResourceId: DashboardFunction

  StatisticsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: StatisticsFunction
      Handler: statistics.App::handleRequest
      Role: !GetAtt CommonLambdaRole.Arn
      Environment:
        Variables:
          STATISTICS_TABLE: !Ref DailyStatisticsTable
      Events:
        API1:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/statistics/today
            Method: get
        API2:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/statistics/weekly
            Method: get
    Metadata:
      SamResourceId: StatisticsFunction
  AuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AuthFunction
      Handler: com.speaktracker.auth.AuthHandler::handleRequest
      Role: !GetAtt CommonLambdaRole.Arn
      Environment:
        Variables:
          USER_POOL_ID: !Ref UserPool
          CLIENT_ID: !Ref UserPoolClient
          USERS_TABLE: !Ref UsersTable
          TUTOR_STUDENTS_TABLE: !Ref TutorStudentsTable
          PROFILE_IMAGES_BUCKET: !Ref ProfileImagesBucket
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - cognito-idp:AdminInitiateAuth
                - cognito-idp:AdminCreateUser
                - cognito-idp:AdminSetUserPassword
                - cognito-idp:SignUp
                - cognito-idp:InitiateAuth
                - cognito-idp:GetUser
                - cognito-idp:AdminGetUser
                - cognito-idp:ConfirmSignUp
              Resource: !GetAtt UserPool.Arn
            - Effect: Allow
              Action:
                - dynamodb:PutItem
                - dynamodb:GetItem
                - dynamodb:Query
                - dynamodb:UpdateItem
              Resource:
                - !GetAtt UsersTable.Arn
                - !GetAtt TutorStudentsTable.Arn
                - !Sub "${TutorStudentsTable.Arn}/index/*"
            - Effect: Allow
              Action:
                - s3:PutObject
                - s3:GetObject
              Resource:
                - !Sub '${ProfileImagesBucket.Arn}/*'
      Events:
        API1:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/auth/register
            Method: post
        API2:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/auth/login
            Method: post
        API3:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/auth/confirm
            Method: post
        API4:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/auth/refresh
            Method: post
        API5:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/auth/user
            Method: get
        API6:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/auth
            Method: get
        API7:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/auth/profile
            Method: put
        API8:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/auth/profile/image
            Method: post

    Metadata:
      SamResourceId: AuthFunction

  StudentStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: StudentStatusFunction
      Handler: com.speaktracker.studentstatus.StudentStatusHandler::handleRequest
      Role: !GetAtt CommonLambdaRole.Arn
      Environment:
        Variables:
          USERS_TABLE: !Ref UsersTable
          TUTOR_STUDENTS_TABLE: !Ref TutorStudentsTable
      Events:
        API1:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/student-status
            Method: get
        API2:
          Type: Api
          Properties:
            RestApiId:
              Ref: MyApi
            Path: /api/student-status
            Method: post
    Metadata:
      SamResourceId: StudentStatusFunction

  # ========================================
  # WebSocket Function
  # ========================================
  SentencesWebSocketFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SentencesWebSocketFunction
      Handler: websocket.SocketHandler::handleRequest
      Role: !GetAtt WebSocketLambdaRole.Arn
      Environment:
        Variables:
          CONNECTIONS_TABLE: !Ref WebSocketConnectionsTable
    Metadata:
      SamResourceId: SentencesWebSocketFunction

  # WebSocket API Gateway
  WebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: SpeakTrackerWebSocketAPI
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: $request.body.action

  # Lambda 실행 권한
  WebSocketLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SentencesWebSocketFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*'

  # Lambda Integration
  WebSocketIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${SentencesWebSocketFunction.Arn}/invocations'

  # $connect Route
  ConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $connect
      Target: !Sub 'integrations/${WebSocketIntegration}'

  # $disconnect Route
  DisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $disconnect
      Target: !Sub 'integrations/${WebSocketIntegration}'

  # $default Route
  DefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $default
      Target: !Sub 'integrations/${WebSocketIntegration}'

  # WebSocket Stage
  WebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      StageName: Dev
      ApiId: !Ref WebSocketApi
      AutoDeploy: true

  # ========================================
  # Feedback Persistence Function (SQS Consumer)
  # ========================================
  FeedbackPersistenceFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: FeedbackPersistenceFunction
      Handler: com.speaktracker.FeedbackPersistenceHandler::handleRequest
      Runtime: java21
      Timeout: 60
      MemorySize: 512
      Environment:
        Variables:
          FEEDBACK_TABLE: !Ref FeedbackMessagesTable
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt FeedbackQueue.Arn
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 5
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref FeedbackMessagesTable
        - SQSPollerPolicy:
            QueueName: !GetAtt FeedbackQueue.QueueName
    Metadata:
      SamResourceId: FeedbackPersistenceFunction

  MyApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Dev
      Cors:
        AllowOrigin: "'*'"
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token,X-Language-Code,X-Mime-Type'"
        MaxAge: "'3600'"
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'*'"
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'*'"
      Auth:
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt UserPool.Arn
            IdentitySource: method.request.header.Authorization

  # ========================================
  # SQS Queues for Feedback Persistence
  # ========================================
  FeedbackQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-tutor-feedback-queue'
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt FeedbackDLQ.Arn
        maxReceiveCount: 3

  FeedbackDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-tutor-feedback-dlq'
      MessageRetentionPeriod: 1209600

  # ========================================
  # SQS Queues for Notification Persistence
  # ========================================
  NotificationQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-tutor-registration-notification-queue'
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt NotificationDLQ.Arn
        maxReceiveCount: 3

  NotificationDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-tutor-registration-notification-dlq'
      MessageRetentionPeriod: 1209600

  # ========================================
  # DynamoDB Tables for Tutor Registration
  # ========================================
  TutorRequestsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-tutor-requests'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: request_id
          AttributeType: S
        - AttributeName: created_at
          AttributeType: N
        - AttributeName: student_email
          AttributeType: S
        - AttributeName: tutor_email_status
          AttributeType: S
      KeySchema:
        - AttributeName: request_id
          KeyType: HASH
        - AttributeName: created_at
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: student_email-created_at-index
          KeySchema:
            - AttributeName: student_email
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: tutor_email_status-created_at-index
          KeySchema:
            - AttributeName: tutor_email_status
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: Tutor Requests Table

  NotificationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${AWS::StackName}-notifications'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_email
          AttributeType: S
        - AttributeName: notification_id_timestamp
          AttributeType: S
        - AttributeName: is_read_created_at
          AttributeType: S
      KeySchema:
        - AttributeName: user_email
          KeyType: HASH
        - AttributeName: notification_id_timestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: user_email-is_read-created_at-index
          KeySchema:
            - AttributeName: user_email
              KeyType: HASH
            - AttributeName: is_read_created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: Notifications Table

  # ========================================
  # Lambda Functions for Tutor Registration
  # ========================================
  TutorRegisterFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: TutorRegisterFunction
      Handler: com.speaktracker.tutorRegister.TutorRegisterHandler::handleRequest
      Runtime: java21
      Timeout: 30
      MemorySize: 512
      Role: !GetAtt CommonLambdaRole.Arn
      Environment:
        Variables:
          USERS_TABLE: !Ref UsersTable
          TUTOR_REQUESTS_TABLE: !Ref TutorRequestsTable
          TUTOR_STUDENTS_TABLE: !Ref TutorStudentsTable
          CONNECTIONS_TABLE: !Ref WebSocketConnectionsTable
          NOTIFICATIONS_TABLE: !Ref NotificationsTable
          NOTIFICATION_QUEUE_URL: !Ref NotificationQueue
          SES_SENDER_EMAIL: noreply@example.com
          FRONTEND_URL: https://example.com
          WEBSOCKET_API_ENDPOINT: !Sub 'https://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/Dev'
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref TutorRequestsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref TutorStudentsTable
        - DynamoDBReadPolicy:
            TableName: !Ref WebSocketConnectionsTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt NotificationQueue.QueueName
        - SESCrudPolicy:
            IdentityName: "*"
      Events:
        GetTutors:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /api/tutors
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        CreateRequest:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /api/tutors/{email}/request
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        GetMyRequests:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /api/my/tutor-requests
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        CancelRequest:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /api/my/tutor-requests/{id}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer
        GetTutorRequests:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /api/tutor/requests
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        ApproveRequest:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /api/tutors/requests/{id}/approve
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        RejectRequest:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /api/tutors/requests/{id}/reject
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer
        GetNotifications:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /api/notifications
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer
        MarkNotificationAsRead:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /api/notifications/{id}
            Method: PUT
            Auth:
              Authorizer: CognitoAuthorizer

  NotificationPersistenceFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: NotificationPersistenceFunction
      Handler: com.speaktracker.notificationpersistence.NotificationPersistenceHandler::handleRequest
      Runtime: java21
      Timeout: 60
      MemorySize: 512
      Environment:
        Variables:
          NOTIFICATIONS_TABLE: !Ref NotificationsTable
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt NotificationQueue.Arn
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 5
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref NotificationsTable
        - SQSPollerPolicy:
            QueueName: !GetAtt NotificationQueue.QueueName

  # DLQ 모니터링 알람
  FeedbackDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${AWS::StackName}-FeedbackDLQ-MessagesAvailable'
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: QueueName
          Value: !GetAtt FeedbackDLQ.QueueName

Outputs:
  ApiEndpoint:
    Description: API Gateway Base URL
    Value:
      Fn::Sub: https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/Dev
  HelloWorldUrl:
    Value:
      Fn::Sub: https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/Dev/hello
  TutorsListUrl:
    Value:
      Fn::Sub: https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/Dev/api/tutors
  SessionsUrl:
    Value:
      Fn::Sub: https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/Dev/api/sessions
  SentencesUrl:
    Value:
      Fn::Sub: https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/Dev/api/sentences
  StatisticsUrl:
    Value:
      Fn::Sub: https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/Dev/api/statistics
  AuthUrl:
    Value:
      Fn::Sub: https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/Dev/api/auth
  StudentStatusApiEndpoint:
    Description: "API Gateway endpoint URL for Student Status"
    Value: !Sub "https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/Dev/api/student-status"

  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool
    Export:
      Name: !Sub ${AWS::StackName}-UserPoolId
  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub ${AWS::StackName}-UserPoolClientId
  UserPoolArn:
    Description: Cognito User Pool ARN
    Value: !GetAtt UserPool.Arn

  UsersTableName:
    Description: Users Table Name
    Value: !Ref UsersTable
    Export:
      Name: !Sub '${AWS::StackName}-UsersTable'

  TutorStudentsTableName:
    Description: Tutor Students Table Name
    Value: !Ref TutorStudentsTable
    Export:
      Name: !Sub '${AWS::StackName}-TutorStudentsTable'

  LearningSessionsTableName:
    Description: Learning Sessions Table Name
    Value: !Ref LearningSessionsTable
    Export:
      Name: !Sub '${AWS::StackName}-LearningSessionsTable'

  DailyStatisticsTableName:
    Description: Daily Statistics Table Name
    Value: !Ref DailyStatisticsTable
    Export:
      Name: !Sub '${AWS::StackName}-DailyStatisticsTable'

  AIConversationsTableName:
    Description: AI Conversations Table Name
    Value: !Ref AIConversationsTable
    Export:
      Name: !Sub '${AWS::StackName}-AIConversationsTable'

  FeedbackMessagesTableName:
    Description: Feedback Messages Table Name
    Value: !Ref FeedbackMessagesTable
    Export:
      Name: !Sub '${AWS::StackName}-FeedbackMessagesTable'

  WebSocketConnectionsTableName:
    Description: WebSocket Connections Table Name
    Value: !Ref WebSocketConnectionsTable
    Export:
      Name: !Sub '${AWS::StackName}-WebSocketConnectionsTable'

  SentencesTableName:
    Description: Sentences Table Name
    Value: !Ref SentencesTable
    Export:
      Name: !Sub '${AWS::StackName}-SentencesTable'

  TTSUrl:
    Description: TTS API URL
    Value: !Sub 'https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/Dev/api/tts'

  TTSAudioBucketName:
    Description: TTS Audio S3 Bucket Name
    Value: !Ref TTSBucket
    Export:
      Name: !Sub '${AWS::StackName}-TTSAudioBucket'

  FeedbackQueueUrl:
    Description: Feedback SQS Queue URL
    Value: !Ref FeedbackQueue
    Export:
      Name: !Sub '${AWS::StackName}-FeedbackQueueUrl'

  FeedbackDLQUrl:
    Description: Feedback DLQ URL
    Value: !Ref FeedbackDLQ
    Export:
      Name: !Sub '${AWS::StackName}-FeedbackDLQUrl'

  TutorRequestsTableName:
    Description: Tutor Requests Table Name
    Value: !Ref TutorRequestsTable
    Export:
      Name: !Sub '${AWS::StackName}-TutorRequestsTable'

  NotificationsTableName:
    Description: Notifications Table Name
    Value: !Ref NotificationsTable
    Export:
      Name: !Sub '${AWS::StackName}-NotificationsTable'

  NotificationQueueUrl:
    Description: Notification SQS Queue URL
    Value: !Ref NotificationQueue
    Export:
      Name: !Sub '${AWS::StackName}-NotificationQueueUrl'

  NotificationDLQUrl:
    Description: Notification DLQ URL
    Value: !Ref NotificationDLQ
    Export:
      Name: !Sub '${AWS::StackName}-NotificationDLQUrl'

  TutorRegisterUrl:
    Description: Tutor Register API URL
    Value: !Sub 'https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/Dev/api/tutors'